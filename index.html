<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√≤ng Quay Pixel May M·∫Øn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #202020; /* N·ªÅn t·ªëi ki·ªÉu game retro */
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden; /* NgƒÉn ph√°o hoa tr√†n ra ngo√†i */
        }
        .game-container {
            background-color: #303030;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 0 5px #444444, 0 0 0 10px #555555, 0 0 20px rgba(0,0,0,0.7);
            text-align: center;
        }
        .game-title {
            color: #ffcc00; /* V√†ng pixel */
            text-shadow: 2px 2px #000000;
            margin-bottom: 20px;
            font-size: 1.8rem; /* K√≠ch th∆∞·ªõc font cho ti√™u ƒë·ªÅ */
        }
        .wheel-wrapper {
            position: relative;
            width: 300px; /* Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc v√≤ng quay */
            height: 300px;
            margin: 0 auto 30px auto;
        }
        #pixelWheelCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 7s cubic-bezier(0.25, 0.1, 0.25, 1);
            border: 4px solid #505050;
            image-rendering: pixelated; /* Gi·ªØ hi·ªáu ·ª©ng pixel khi v·∫Ω */
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ff3030; /* M√†u ƒë·ªè pixel cho kim */
            z-index: 10;
        }
        #spinButton {
            background-color: #00b800; /* Xanh l√° pixel */
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: 2px solid #008000;
            box-shadow: 0 4px #005000;
            text-shadow: 1px 1px #000000;
        }
        #spinButton:hover:not(:disabled) {
            background-color: #00d800;
        }
        #spinButton:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #005000;
        }
        #spinButton:disabled {
            background-color: #707070;
            border-color: #505050;
            box-shadow: 0 4px #303030;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .spin-chances-text {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #dddddd;
        }
        .spin-chances-text span {
            color: #ffcc00;
            font-size: 1rem;
        }

        /* Popup k·∫øt qu·∫£ */
        .result-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }
        .result-popup-content {
            background-color: #404040;
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 0 4px #585858, 0 0 15px rgba(0,0,0,0.5);
            border: 3px solid #707070;
            max-width: 90%;
            width: 350px;
        }
        .result-popup-content h2 {
            font-size: 1.5rem;
            color: #ffcc00;
            margin-bottom: 15px;
            text-shadow: 2px 2px #000;
        }
        .result-popup-content p {
            font-size: 1rem;
            margin-bottom: 20px;
        }
        .result-popup-content p strong {
            color: #00ff00; /* M√†u xanh l√° cho ph·∫ßn th∆∞·ªüng t·ªët */
            font-size: 1.1em;
        }
        .result-popup-content p.sad-message strong {
            color: #ff5050; /* M√†u ƒë·ªè cho th√¥ng b√°o bu·ªìn */
        }
        .result-popup-content button {
            background-color: #ffcc00;
            color: #202020;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            border: 2px solid #e0b000;
            box-shadow: 0 3px #c09000;
            transition: background-color 0.2s, transform 0.1s;
        }
        .result-popup-content button:hover {
            background-color: #ffeeaa;
        }
        .result-popup-content button:active {
            transform: translateY(1px);
            box-shadow: 0 2px #c09000;
        }
        .reward-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        /* Fireworks Canvas */
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ƒê·ªÉ kh√¥ng c·∫£n click */
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title text-2xl md:text-3xl">V√íNG QUAY PIXEL</h1>
        <p id="spinMessage" class="text-xs text-gray-400 mb-6">Th·ª≠ v·∫≠n may c·ªßa b·∫°n!</p>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="pixelWheelCanvas" width="300" height="300"></canvas>
        </div>

        <button id="spinButton"><i class="fas fa-play mr-2"></i>QUAY NGAY!</button>
        <p class="spin-chances-text">L∆∞·ª£t quay h√¥m nay: <span id="spinChancesToday">1</span></p>
    </div>

    <div id="resultPopup" class="result-popup">
        <div class="result-popup-content">
            <div id="rewardIconDisplay" class="reward-icon"></div>
            <h2 id="resultTitle">CH√öC M·ª™NG!</h2>
            <p id="rewardTextDisplay">B·∫°n ƒë√£ tr√∫ng: ...</p>
            <button id="closePopup">OK</button>
        </div>
    </div>

    <canvas id="fireworksCanvas"></canvas>

    <script>
        const wheelCanvas = document.getElementById('pixelWheelCanvas');
        const ctx = wheelCanvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resultPopup = document.getElementById('resultPopup');
        const resultTitleEl = document.getElementById('resultTitle');
        const rewardTextDisplayEl = document.getElementById('rewardTextDisplay');
        const rewardIconDisplayEl = document.getElementById('rewardIconDisplay');
        const closePopup = document.getElementById('closePopup');
        const spinChancesTodayEl = document.getElementById('spinChancesToday');
        const spinMessageEl = document.getElementById('spinMessage');
        const fireworksCanvas = document.getElementById('fireworksCanvas');
        const fireworksCtx = fireworksCanvas.getContext('2d');

        let spinsAvailableToday = 1;
        let spinning = false;
        let currentAngle = 0;

        // --- √Çm thanh v·ªõi Tone.js ---
        const winSound = new Tone.Synth({
            oscillator: { type: "triangle" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 }
        }).toDestination();
        winSound.volume.value = -10;

        const loseSound = new Tone.Synth({
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 }
        }).toDestination();
        loseSound.volume.value = -10;

        const rewards = [
            { text: "10.000 VNƒê", probability: 0.30, color: "#4CAF50", icon: "üí∞", isGood: true },
            { text: "15.000 VNƒê", probability: 0.20, color: "#2196F3", icon: "üí∞", isGood: true },
            { text: "May m·∫Øn l·∫ßn sau!", probability: 0.20, color: "#9E9E9E", icon: "üò•", isGood: false }, // S·ª≠a l·∫°i m·ªôt ch√∫t cho th√¢n thi·ªán
            { text: "20.000 VNƒê", probability: 0.12, color: "#FFC107", icon: "üí∞", isGood: true },
            { text: "B√πa H·ªô Chu·ªói", probability: 0.08, color: "#9C27B0", icon: "üõ°Ô∏è", isGood: true }, // R√∫t g·ªçn t√™n
            { text: "25.000 VNƒê", probability: 0.06, color: "#FF5722", icon: "üí∞", isGood: true },
            { text: "30.000 VNƒê", probability: 0.04, color: "#E91E63", icon: "üíé", isGood: true }
        ];

        const numSegments = rewards.length;
        const anglePerSegment = (2 * Math.PI) / numSegments;

        function getTodayDateString() {
            return new Date().toDateString();
        }

        function checkSpinAvailability() {
            const lastSpinDate = localStorage.getItem('pixelWheelLastSpinDate');
            const today = getTodayDateString();

            if (lastSpinDate === today) {
                spinsAvailableToday = 0;
                spinButton.disabled = true;
                spinMessageEl.textContent = "B·∫°n ƒë√£ h·∫øt l∆∞·ª£t quay h√¥m nay. Mai quay l·∫°i nh√©!"; // Thay ƒë·ªïi th√¥ng b√°o
                spinMessageEl.classList.add("text-yellow-400");
            } else {
                spinsAvailableToday = 1;
                spinButton.disabled = false;
                spinMessageEl.textContent = "Th·ª≠ v·∫≠n may c·ªßa b·∫°n!";
                spinMessageEl.classList.remove("text-yellow-400");
            }
            spinChancesTodayEl.textContent = spinsAvailableToday;
        }

        function drawPixelText(text, x, y, color = "#FFFFFF", fontSize = 10, fontWeight = "normal") {
            ctx.fillStyle = color;
            ctx.font = `${fontWeight} ${fontSize}px 'Press Start 2P'`; // Th√™m fontWeight
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x, y);
        }
        
        function drawWheel() {
            const radius = wheelCanvas.width / 2;
            ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            rewards.forEach((reward, i) => {
                const angle = i * anglePerSegment;
                ctx.beginPath();
                ctx.moveTo(radius, radius);
                ctx.arc(radius, radius, radius - 2, angle, angle + anglePerSegment);
                ctx.closePath();
                ctx.fillStyle = reward.color;
                ctx.fill();
                ctx.strokeStyle = "#181818"; 
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.save();
                ctx.translate(radius, radius);
                ctx.rotate(angle + anglePerSegment / 2);
                
                const iconText = reward.icon;
                const rewardName = reward.text;
                
                // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ v√† k√≠ch th∆∞·ªõc
                const iconSize = 20; // K√≠ch th∆∞·ªõc icon l·ªõn h∆°n
                const textSize = rewardName.includes("VNƒê") || rewardName.length > 15 ? 7 : 8; // Font ch·ªØ to h∆°n m·ªôt ch√∫t
                const textYOffset = iconText ? 10 : 0; // D·ªãch ch·ªØ xu·ªëng n·∫øu c√≥ icon

                if (iconText) {
                    // V·∫Ω icon to h∆°n
                    drawPixelText(iconText, radius * 0.55, -5, "#FFFFFF", iconSize, "normal"); // Gi·∫£m ƒë·ªô d·ªãch ra ngo√†i m·ªôt ch√∫t
                }
                // V·∫Ω ch·ªØ to h∆°n, ƒë·∫≠m h∆°n
                drawPixelText(rewardName, radius * 0.55, textYOffset, "#FFFFFF", textSize, "bold");

                ctx.restore();
            });
        }

        function getReward() {
            let rand = Math.random();
            let cumulativeProbability = 0;
            for (let i = 0; i < rewards.length; i++) {
                cumulativeProbability += rewards[i].probability;
                if (rand <= cumulativeProbability) {
                    return i;
                }
            }
            return rewards.length - 1;
        }

        fireworksCanvas.width = window.innerWidth;
        fireworksCanvas.height = window.innerHeight;
        let particles = [];

        function Particle(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.size = Math.random() * 4 + 2; // Pixel to h∆°n
            this.speedX = Math.random() * 8 - 4; // T·ªëc ƒë·ªô nhanh h∆°n
            this.speedY = Math.random() * 8 - 4;
            this.life = 60 + Math.random() * 60; // T·ªìn t·∫°i l√¢u h∆°n
        }

        Particle.prototype.update = function() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.speedY += 0.07; // Gravity m·∫°nh h∆°n ch√∫t
            this.life -= 1;
        };

        Particle.prototype.draw = function() {
            fireworksCtx.fillStyle = this.color;
            fireworksCtx.fillRect(this.x, this.y, this.size, this.size); // V·∫Ω h√¨nh vu√¥ng pixel
        };

        function createFireworks(x, y) {
            particles = [];
            const particleCount = 150; // Nhi·ªÅu h·∫°t h∆°n
            const colors = ["#FFD700", "#FF69B4", "#00FFFF", "#7FFF00", "#FF4500", "#FFFFFF"];
            for (let i = 0; i < particleCount; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                particles.push(new Particle(x, y, color));
            }
        }

        function animateFireworks() {
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
            if (particles.length > 0) {
                requestAnimationFrame(animateFireworks);
            }
        }

        spinButton.addEventListener('click', () => {
            if (spinning || spinsAvailableToday <= 0) return;

            spinning = true;
            spinButton.disabled = true;
            spinsAvailableToday--;
            spinChancesTodayEl.textContent = spinsAvailableToday;
            localStorage.setItem('pixelWheelLastSpinDate', getTodayDateString());

            const now = Tone.now();
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C3", "8n", now); // √Çm tr·∫ßm h∆°n
            synth.triggerAttackRelease("E3", "8n", now + 0.1);
            synth.triggerAttackRelease("G3", "8n", now + 0.2);

            const winningSegmentIndex = getReward();
            const winningReward = rewards[winningSegmentIndex];
            const angleToWinningSegmentCenter = (2 * Math.PI) - (winningSegmentIndex * anglePerSegment + anglePerSegment / 2);
            const randomOffset = (Math.random() - 0.5) * anglePerSegment * 0.7;
            const randomSpins = Math.floor(Math.random() * 3) + 7;
            const totalRotation = (randomSpins * 2 * Math.PI) + angleToWinningSegmentCenter + randomOffset;
            
            currentAngle += totalRotation;
            wheelCanvas.style.transform = `rotate(${currentAngle}rad)`;

            setTimeout(() => {
                spinning = false;
                
                let rewardMessage = winningReward.text;
                rewardIconDisplayEl.textContent = winningReward.icon;
                rewardTextDisplayEl.classList.remove("sad-message");

                if (winningReward.isGood) {
                    resultTitleEl.textContent = "CHI·∫æN TH·∫ÆNG!";
                    rewardTextDisplayEl.innerHTML = `B·∫°n nh·∫≠n ƒë∆∞·ª£c: <strong>${rewardMessage}</strong>`;
                    winSound.triggerAttackRelease("C5", "8n", Tone.now());
                    winSound.triggerAttackRelease("G5", "8n", Tone.now() + 0.1);
                    winSound.triggerAttackRelease("C6", "4n", Tone.now() + 0.2);
                    winSound.triggerAttackRelease("E6", "2n", Tone.now() + 0.35); // √Çm cao h∆°n, vui h∆°n
                    createFireworks(Math.random() * fireworksCanvas.width, Math.random() * fireworksCanvas.height / 2); // Ph√°o hoa ·ªü nhi·ªÅu v·ªã tr√≠
                    setTimeout(() => createFireworks(Math.random() * fireworksCanvas.width, Math.random() * fireworksCanvas.height / 2), 300); // Th√™m ƒë·ª£t ph√°o hoa
                    animateFireworks();
                } else {
                    resultTitleEl.textContent = "·ªêI...";
                    rewardTextDisplayEl.innerHTML = `<strong class="sad-message">${rewardMessage}</strong>`;
                    rewardTextDisplayEl.classList.add("sad-message");
                    loseSound.triggerAttackRelease("A2", "2n", Tone.now()); // √Çm tr·∫ßm bu·ªìn
                    loseSound.triggerAttackRelease("F2", "1n", Tone.now() + 0.3);
                }
                
                resultPopup.style.display = 'flex';
                checkSpinAvailability();

            }, 7100);
        });

        closePopup.addEventListener('click', () => {
            resultPopup.style.display = 'none';
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        });

        // Kh·ªüi t·∫°o
        drawWheel();
        checkSpinAvailability();
    </script>
</body>
</html>
